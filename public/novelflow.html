<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Novelflow Â· å™äº‹å¼•æ“</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --ink: #0a0806;
        --parchment: #f5f0e8;
        --blood: #8b1a1a;
        --gold: #c9a227;
        --dim: #2a2420;
        --mist: #b8a898;
        --glow: rgba(201, 162, 39, 0.15);
        --success: #4a7c59;
        --fail: #7c3a2a;
        --crit: #1a4a6e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--ink);
        color: var(--parchment);
        font-family: "Noto Serif SC", serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      /* Atmospheric background */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: 0;
        background:
          radial-gradient(
            ellipse 80% 50% at 20% 80%,
            rgba(139, 26, 26, 0.08) 0%,
            transparent 60%
          ),
          radial-gradient(
            ellipse 60% 40% at 80% 20%,
            rgba(201, 162, 39, 0.06) 0%,
            transparent 60%
          ),
          repeating-linear-gradient(
            0deg,
            transparent,
            transparent 2px,
            rgba(255, 255, 255, 0.008) 2px,
            rgba(255, 255, 255, 0.008) 4px
          );
        pointer-events: none;
      }

      /* Scanlines overlay */
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        z-index: 0;
        background: repeating-linear-gradient(
          transparent 0px,
          transparent 3px,
          rgba(0, 0, 0, 0.15) 3px,
          rgba(0, 0, 0, 0.15) 4px
        );
        pointer-events: none;
      }

      header {
        position: relative;
        z-index: 10;
        padding: 24px 40px;
        border-bottom: 1px solid rgba(201, 162, 39, 0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(10, 8, 6, 0.8);
        backdrop-filter: blur(4px);
      }

      .logo {
        font-family: "Cinzel", serif;
        font-size: 1.6rem;
        letter-spacing: 0.15em;
        color: var(--gold);
        text-shadow: 0 0 30px rgba(201, 162, 39, 0.4);
      }

      .logo span {
        color: var(--mist);
        font-size: 0.9rem;
        letter-spacing: 0.3em;
        display: block;
        font-family: "Share Tech Mono", monospace;
        margin-top: 2px;
      }

      .sys-badge {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.7rem;
        color: var(--mist);
        background: rgba(201, 162, 39, 0.08);
        border: 1px solid rgba(201, 162, 39, 0.2);
        padding: 4px 12px;
        letter-spacing: 0.1em;
      }

      .sys-badge .dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #4a7c59;
        margin-right: 6px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      /* Main layout */
      .app {
        position: relative;
        z-index: 5;
        display: grid;
        grid-template-columns: 280px 1fr 260px;
        gap: 0;
        flex: 1;
        height: calc(100vh - 73px);
      }

      /* Left panel - Player State */
      .panel-left {
        border-right: 1px solid rgba(201, 162, 39, 0.15);
        padding: 24px 20px;
        overflow-y: auto;
        background: rgba(10, 8, 6, 0.5);
      }

      .panel-title {
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.3em;
        color: var(--gold);
        text-transform: uppercase;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(201, 162, 39, 0.15);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .panel-title::before {
        content: "â—†";
        font-size: 0.6rem;
      }

      .stat-block {
        margin-bottom: 20px;
      }

      .stat-label {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.65rem;
        color: var(--mist);
        letter-spacing: 0.1em;
        margin-bottom: 6px;
        text-transform: uppercase;
      }

      .stat-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }

      .stat-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.8s ease;
      }

      .hp-fill {
        background: linear-gradient(90deg, var(--blood), #c0392b);
      }
      .spirit-fill {
        background: linear-gradient(90deg, #1a4a6e, #2980b9);
      }
      .awaken-fill {
        background: linear-gradient(90deg, var(--gold), #f0c040);
      }

      .stat-value {
        font-family: "Share Tech Mono", monospace;
        font-size: 1.1rem;
        color: var(--parchment);
        display: flex;
        justify-content: space-between;
        align-items: baseline;
      }

      .stat-value small {
        font-size: 0.65rem;
        color: var(--mist);
      }

      .divider {
        border: none;
        border-top: 1px solid rgba(201, 162, 39, 0.1);
        margin: 16px 0;
      }

      .inventory-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-top: 8px;
      }

      .inv-item {
        background: rgba(201, 162, 39, 0.06);
        border: 1px solid rgba(201, 162, 39, 0.15);
        padding: 8px;
        font-size: 0.7rem;
        color: var(--mist);
        text-align: center;
        cursor: default;
        transition: all 0.2s;
      }

      .inv-item:hover {
        border-color: rgba(201, 162, 39, 0.4);
        color: var(--parchment);
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
      }
      .tag {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.6rem;
        padding: 2px 8px;
        background: rgba(201, 162, 39, 0.08);
        border: 1px solid rgba(201, 162, 39, 0.2);
        color: var(--gold);
        letter-spacing: 0.05em;
      }

      /* Center - Narrative */
      .panel-center {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .narrative-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 32px 40px;
        scroll-behavior: smooth;
      }

      .narrative-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .narrative-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .narrative-scroll::-webkit-scrollbar-thumb {
        background: rgba(201, 162, 39, 0.2);
        border-radius: 2px;
      }

      /* Judgment report */
      .judge-card {
        background: rgba(201, 162, 39, 0.04);
        border: 1px solid rgba(201, 162, 39, 0.2);
        border-left: 3px solid var(--gold);
        padding: 16px 20px;
        margin-bottom: 24px;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 16px;
        align-items: start;
        animation: slideIn 0.4s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      .dice-display {
        width: 56px;
        height: 56px;
        border: 2px solid var(--gold);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Cinzel", serif;
        font-size: 1.4rem;
        color: var(--gold);
        position: relative;
        flex-shrink: 0;
      }

      .dice-display::before,
      .dice-display::after {
        content: "";
        position: absolute;
        width: 6px;
        height: 6px;
        border: 1px solid rgba(201, 162, 39, 0.4);
      }
      .dice-display::before {
        top: -4px;
        left: -4px;
        border-right: none;
        border-bottom: none;
      }
      .dice-display::after {
        bottom: -4px;
        right: -4px;
        border-left: none;
        border-top: none;
      }

      .judge-meta {
      }
      .verdict-badge {
        display: inline-block;
        font-family: "Share Tech Mono", monospace;
        font-size: 0.7rem;
        letter-spacing: 0.2em;
        padding: 3px 12px;
        margin-bottom: 8px;
      }

      .verdict-success {
        background: rgba(74, 124, 89, 0.2);
        border: 1px solid var(--success);
        color: #6dbb8a;
      }
      .verdict-fail {
        background: rgba(124, 58, 42, 0.2);
        border: 1px solid var(--fail);
        color: #d4744a;
      }
      .verdict-great {
        background: rgba(26, 74, 110, 0.2);
        border: 1px solid var(--crit);
        color: #5ba3d4;
      }
      .verdict-disaster {
        background: rgba(80, 10, 10, 0.3);
        border: 1px solid #5a0a0a;
        color: #ff4444;
      }

      .judge-reasoning {
        font-size: 0.78rem;
        color: var(--mist);
        line-height: 1.6;
        font-style: italic;
      }

      /* Narrative prose */
      .prose-block {
        margin-bottom: 24px;
        animation: fadeIn 0.6s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .prose-text {
        font-size: 0.95rem;
        line-height: 2;
        color: var(--parchment);
        text-align: justify;
        text-indent: 2em;
        letter-spacing: 0.02em;
      }

      .prose-text p {
        margin-bottom: 1em;
      }

      .sensory-note {
        margin-top: 12px;
        padding: 10px 16px;
        border-left: 2px solid rgba(201, 162, 39, 0.3);
        font-size: 0.8rem;
        color: var(--mist);
        font-style: italic;
        letter-spacing: 0.05em;
      }

      /* Chapter marker */
      .chapter-marker {
        text-align: center;
        margin: 32px 0;
        position: relative;
      }

      .chapter-marker::before,
      .chapter-marker::after {
        content: "";
        position: absolute;
        top: 50%;
        width: calc(50% - 60px);
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(201, 162, 39, 0.3)
        );
      }
      .chapter-marker::before {
        left: 0;
      }
      .chapter-marker::after {
        right: 0;
        background: linear-gradient(
          -90deg,
          transparent,
          rgba(201, 162, 39, 0.3)
        );
      }

      .chapter-marker span {
        font-family: "Cinzel", serif;
        font-size: 0.65rem;
        color: var(--gold);
        letter-spacing: 0.3em;
        background: var(--ink);
        padding: 0 12px;
      }

      /* Input area */
      .input-area {
        border-top: 1px solid rgba(201, 162, 39, 0.15);
        padding: 20px 40px;
        background: rgba(10, 8, 6, 0.7);
        backdrop-filter: blur(4px);
      }

      .options-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .option-btn {
        background: rgba(201, 162, 39, 0.05);
        border: 1px solid rgba(201, 162, 39, 0.2);
        color: var(--mist);
        padding: 10px 14px;
        text-align: left;
        cursor: pointer;
        font-family: "Noto Serif SC", serif;
        font-size: 0.78rem;
        line-height: 1.4;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }

      .option-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(201, 162, 39, 0.1),
          transparent
        );
        opacity: 0;
        transition: opacity 0.2s;
      }

      .option-btn:hover {
        border-color: rgba(201, 162, 39, 0.5);
        color: var(--parchment);
      }

      .option-btn:hover::before {
        opacity: 1;
      }

      .option-type {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.6rem;
        color: var(--gold);
        letter-spacing: 0.1em;
        display: block;
        margin-bottom: 3px;
      }

      .custom-row {
        display: flex;
        gap: 8px;
      }

      .action-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(201, 162, 39, 0.2);
        color: var(--parchment);
        padding: 10px 16px;
        font-family: "Noto Serif SC", serif;
        font-size: 0.85rem;
        outline: none;
        transition: border-color 0.2s;
      }

      .action-input::placeholder {
        color: rgba(184, 168, 152, 0.4);
      }
      .action-input:focus {
        border-color: rgba(201, 162, 39, 0.5);
      }

      .submit-btn {
        background: rgba(201, 162, 39, 0.1);
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 10px 24px;
        font-family: "Cinzel", serif;
        font-size: 0.8rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .submit-btn:hover {
        background: rgba(201, 162, 39, 0.2);
        box-shadow: 0 0 20px rgba(201, 162, 39, 0.2);
      }

      .submit-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      /* Right panel - Log */
      .panel-right {
        border-left: 1px solid rgba(201, 162, 39, 0.15);
        padding: 24px 16px;
        overflow-y: auto;
        background: rgba(10, 8, 6, 0.5);
        font-family: "Share Tech Mono", monospace;
      }

      .log-entry {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        animation: slideIn 0.3s ease;
      }

      .log-time {
        font-size: 0.6rem;
        color: rgba(184, 168, 152, 0.4);
        margin-bottom: 3px;
      }

      .log-action {
        font-size: 0.7rem;
        color: var(--mist);
        margin-bottom: 4px;
        line-height: 1.4;
      }

      .log-result {
        font-size: 0.65rem;
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .log-roll {
        color: var(--gold);
      }
      .log-verdict-s {
        color: #6dbb8a;
      }
      .log-verdict-f {
        color: #d4744a;
      }
      .log-verdict-g {
        color: #5ba3d4;
      }
      .log-verdict-d {
        color: #ff4444;
      }

      /* Loading state */
      .loading-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 12px 0;
        font-family: "Share Tech Mono", monospace;
        font-size: 0.7rem;
        color: var(--mist);
        letter-spacing: 0.1em;
      }

      .loading-indicator.active {
        display: flex;
      }

      .loading-dots span {
        display: inline-block;
        width: 4px;
        height: 4px;
        background: var(--gold);
        border-radius: 50%;
        animation: blink 1.2s infinite;
        margin: 0 2px;
      }

      .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0.2;
        }
        40% {
          opacity: 1;
        }
      }

      .error-msg {
        background: rgba(124, 58, 42, 0.15);
        border: 1px solid rgba(124, 58, 42, 0.4);
        color: #d4744a;
        padding: 12px 16px;
        font-size: 0.8rem;
        margin-bottom: 12px;
        display: none;
      }

      /* Scrollbar for panels */
      .panel-left::-webkit-scrollbar,
      .panel-right::-webkit-scrollbar {
        width: 3px;
      }
      .panel-left::-webkit-scrollbar-thumb,
      .panel-right::-webkit-scrollbar-thumb {
        background: rgba(201, 162, 39, 0.15);
      }

      /* Upload area */
      .upload-zone {
        border: 1px dashed rgba(201, 162, 39, 0.25);
        padding: 12px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 16px;
        transition: all 0.2s;
      }

      .upload-zone:hover {
        border-color: rgba(201, 162, 39, 0.5);
        background: rgba(201, 162, 39, 0.03);
      }

      .upload-zone input {
        display: none;
      }

      .upload-zone p {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.65rem;
        color: var(--mist);
        letter-spacing: 0.08em;
      }

      .upload-zone .icon {
        font-size: 1.2rem;
        margin-bottom: 4px;
        opacity: 0.5;
      }

      .file-loaded {
        font-family: "Share Tech Mono", monospace;
        font-size: 0.65rem;
        color: var(--success);
        padding: 6px 8px;
        background: rgba(74, 124, 89, 0.1);
        border: 1px solid rgba(74, 124, 89, 0.3);
        display: none;
        margin-bottom: 12px;
      }

      /* Initial scene */
      .welcome-prose {
        text-align: center;
        padding: 60px 40px;
      }

      .welcome-prose .title {
        font-family: "Cinzel", serif;
        font-size: 2rem;
        color: var(--gold);
        letter-spacing: 0.2em;
        text-shadow: 0 0 40px rgba(201, 162, 39, 0.3);
        margin-bottom: 16px;
      }

      .welcome-prose .subtitle {
        font-size: 0.85rem;
        color: var(--mist);
        letter-spacing: 0.1em;
        margin-bottom: 40px;
        font-style: italic;
      }

      .welcome-prose .desc {
        font-size: 0.9rem;
        color: rgba(245, 240, 232, 0.7);
        line-height: 2;
        max-width: 500px;
        margin: 0 auto;
      }

      .ornament {
        color: var(--gold);
        font-size: 1.5rem;
        letter-spacing: 0.5em;
        opacity: 0.4;
        margin: 24px 0;
        display: block;
      }

      /* state delta badges */
      .delta {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-family: "Share Tech Mono", monospace;
        font-size: 0.65rem;
        padding: 2px 8px;
        margin: 2px;
      }
      .delta-neg {
        color: #d4744a;
        background: rgba(124, 58, 42, 0.15);
        border: 1px solid rgba(124, 58, 42, 0.3);
      }
      .delta-pos {
        color: #6dbb8a;
        background: rgba(74, 124, 89, 0.15);
        border: 1px solid rgba(74, 124, 89, 0.3);
      }

      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
        }
        .panel-left,
        .panel-right {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        NOVELFLOW
        <span>NARRATIVE ENGINE Â· NLC V2.0</span>
      </div>
      <div class="sys-badge">
        <span class="dot"></span>
        SYSTEM ONLINE Â· D-CAUSALITY ACTIVE
      </div>
    </header>

    <div class="app">
      <!-- Left Panel: Player State -->
      <div class="panel-left">
        <div class="panel-title">è§’è‰²çŠ¶æ€</div>

        <div
          class="upload-zone"
          id="uploadZone"
          onclick="document.getElementById('mdUpload').click()"
        >
          <input type="file" id="mdUpload" accept=".md,.txt" />
          <div class="icon">ğŸ“œ</div>
          <p>ä¸Šä¼ åŸè‘— Markdown<br />ä»¥åŒ¹é…æ–‡é£</p>
        </div>
        <div class="file-loaded" id="fileLoaded">âœ“ æ–‡é£å·²åŠ è½½</div>

        <div class="stat-block">
          <div class="stat-label">ç”Ÿå‘½å€¼ HP</div>
          <div class="stat-value">
            <span id="hpVal">85</span>
            <small>/ 100</small>
          </div>
          <div class="stat-bar">
            <div class="stat-fill hp-fill" id="hpBar" style="width: 85%"></div>
          </div>
        </div>

        <div class="stat-block">
          <div class="stat-label">ç²¾ç¥åŠ› SPIRIT</div>
          <div class="stat-value">
            <span id="spiritVal">70</span>
            <small>/ 100</small>
          </div>
          <div class="stat-bar">
            <div
              class="stat-fill spirit-fill"
              id="spiritBar"
              style="width: 70%"
            ></div>
          </div>
        </div>

        <div class="stat-block">
          <div class="stat-label">è§‰é†’åº¦ AWAKENING</div>
          <div class="stat-value">
            <span id="awakenVal">12</span>
            <small>%</small>
          </div>
          <div class="stat-bar">
            <div
              class="stat-fill awaken-fill"
              id="awakenBar"
              style="width: 12%"
            ></div>
          </div>
        </div>

        <hr class="divider" />

        <div class="stat-label">æˆ˜åŠ›ç­‰çº§</div>
        <div class="tag-list" id="tagList">
          <span class="tag">LV.5 Â· çµè€…</span>
          <span class="tag">è¿‘æˆ˜å‹</span>
          <span class="tag">é›·å±æ€§</span>
        </div>

        <hr class="divider" />

        <div class="stat-label">æŒæœ‰ç‰©å“</div>
        <div class="inventory-grid" id="inventoryGrid">
          <div class="inv-item">ç¬¦ç¯† Ã—3</div>
          <div class="inv-item">çµçŸ³ Ã—1</div>
          <div class="inv-item">è§£æ¯’ä¸¹</div>
          <div class="inv-item">ç©º</div>
        </div>

        <hr class="divider" />

        <div class="stat-label">çŠ¶æ€å˜åŒ–è®°å½•</div>
        <div id="deltaLog" style="margin-top: 8px"></div>
      </div>

      <!-- Center: Narrative -->
      <div class="panel-center">
        <div class="narrative-scroll" id="narrativeScroll">
          <div class="welcome-prose" id="welcomeScreen">
            <div class="title">Novelflow</div>
            <div class="subtitle">å¤šç»´å› æœå¾‹å™äº‹å¼•æ“</div>
            <span class="ornament">âœ¦ âœ¦ âœ¦</span>
            <div class="desc">
              åœ¨ä¸‹æ–¹è¾“å…¥ä½ çš„è¡ŒåŠ¨ï¼Œç³»ç»Ÿå°†è°ƒç”¨ D-Causality
              ç®—æ³•è¿›è¡Œå¤šç»´åˆ¤å®šï¼Œå¹¶ç”Ÿæˆé«˜æ²‰æµ¸åº¦çš„å™äº‹æ–‡æœ¬ã€‚
              <br /><br />
              ä½ å¯ä»¥ä¸Šä¼ åŸè‘— Markdownï¼Œå¼•æ“å°†å®æ—¶å­¦ä¹ å¹¶å…‹éš†å…¶æ–‡é£ã€‚
              <br /><br />
              <em style="color: var(--mist); font-size: 0.8rem"
                >é€‰æ‹©é¢„è®¾è¡ŒåŠ¨ï¼Œæˆ–åœ¨è¾“å…¥æ¡†ä¸­è‡ªç”±æè¿°ä½ çš„è¡ŒåŠ¨æ„å›¾ã€‚</em
              >
            </div>
            <span class="ornament" style="margin-top: 40px">â—†</span>
          </div>

          <div id="storyContent"></div>

          <div class="loading-indicator" id="loadingIndicator">
            <span>NLC è¿ç®—ä¸­</span>
            <div class="loading-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="error-msg" id="errorMsg"></div>

          <div class="options-row" id="optionsRow">
            <button class="option-btn" onclick="selectOption(this)">
              <span class="option-type">ã€ç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–ã€‘</span>
              æäº¤ç¬¬ä¸€ä¸ªè¡ŒåŠ¨åï¼Œç³»ç»Ÿå°†ç”Ÿæˆä¸“å±é€‰é¡¹
            </button>
            <button class="option-btn" onclick="selectOption(this)">
              <span class="option-type">ã€æç¤ºã€‘</span>
              æè¿°è¶Šè¯¦ç»†ï¼ŒæˆåŠŸæ¦‚ç‡ä¿®æ­£è¶Šé«˜
            </button>
            <button class="option-btn" onclick="selectOption(this)">
              <span class="option-type">ã€æç¤ºã€‘</span>
              ä¸Šä¼ åŸè‘—æ–‡ä»¶å¯å¤§å¹…æå‡å™äº‹è´¨é‡
            </button>
            <button class="option-btn" onclick="selectOption(this)">
              <span class="option-type">ã€æç¤ºã€‘</span>
              è¡ŒåŠ¨é€»è¾‘é¡»ç¬¦åˆå½“å‰å‰§æƒ…ä¸–ç•Œè§‚
            </button>
          </div>

          <div class="custom-row">
            <input
              class="action-input"
              id="actionInput"
              type="text"
              placeholder="æè¿°ä½ çš„è¡ŒåŠ¨æ„å›¾... ï¼ˆä¾‹ï¼šæˆ‘æ‰‘å‘å·¦ä¾§æ©ä½“ï¼ŒåŒæ—¶å¼•å¯¼çµåŠ›æ±‡èšäºå³æŒï¼‰"
              maxlength="500"
            />
            <button class="submit-btn" id="submitBtn" onclick="submitAction()">
              æ‰§è¡Œ â–¸
            </button>
          </div>
        </div>
      </div>

      <!-- Right Panel: Battle Log -->
      <div class="panel-right">
        <div class="panel-title">åˆ¤å®šæ—¥å¿—</div>
        <div id="battleLog">
          <div class="log-entry">
            <div class="log-time">SYSTEM INIT</div>
            <div class="log-action">Novelflow NLC V2.0 å·²æ¿€æ´»</div>
            <div class="log-result">
              <span class="log-roll">D-CAUSALITY</span>
              <span class="log-verdict-s">ONLINE</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const STATE = {
        hp: 85,
        maxHp: 100,
        spirit: 70,
        maxSpirit: 100,
        awakening: 12,
        level: 5,
        targetLevel: 5,
        inventory: ["ç¬¦ç¯† Ã—3", "çµçŸ³ Ã—1", "è§£æ¯’ä¸¹", "ç©º"],
        tags: ["LV.5 Â· çµè€…", "è¿‘æˆ˜å‹", "é›·å±æ€§"],
        styleText: "",
        sessionToken: generateToken(),
        turnCount: 0,
      };

      const SYSTEM_PROMPT = `ä½ æ˜¯ Novelflow æ ¸å¿ƒé€»è¾‘æ§åˆ¶å™¨ (NLC)ã€‚ä½ é›†æˆäº†æ•°å­—åŸä¸»ã€æ–‡é£å¤§å¸ˆå’Œæ•°å€¼ç­–åˆ’ä¸‰é‡èº«ä»½ã€‚

**å½“å‰ç©å®¶çŠ¶æ€ï¼š**
- HP: {HP}/{MAX_HP}
- ç²¾ç¥åŠ›: {SPIRIT}/{MAX_SPIRIT}
- è§‰é†’åº¦: {AWAKENING}%
- æˆ˜åŠ›ç­‰çº§: LV.{LEVEL}
- æ ‡ç­¾: {TAGS}
- ç‰©å“: {INVENTORY}
{STYLE_CONTEXT}

**ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œä¸å¾—è¾“å‡ºä»»ä½• JSON ä»¥å¤–çš„å†…å®¹ï¼š**

{
  "judge_report": {
    "roll": <1-100çš„éšæœºæ•´æ•°>,
    "verdict": <"æƒ¨è´¥"|"æŒ«è´¥"|"æˆåŠŸ"|"å¤§æˆåŠŸ">,
    "reasoning": <åˆ¤å®šé€»è¾‘è¯´æ˜ï¼Œ50å­—ä»¥å†…>
  },
  "narrative": {
    "prose": <300-500å­—é«˜è´¨é‡ä¸­æ–‡å°è¯´æ–‡æœ¬ï¼Œåˆ†å¤šæ®µï¼Œç¦æ­¢æ€»ç»“æ€§è¯æ±‡ï¼Œè¦æ±‚åŠ¨ä½œå¯¼å‘ã€ç”»é¢æ„Ÿå¼ºçƒˆï¼Œ${STATE.styleText ? "ä¸¥æ ¼è´´åˆä¸Šä¼ æ–‡é£" : "é£æ ¼æ²‰éƒã€å†™å®"}>,
    "sensory_detail": <ä¸€å¥æ„Ÿå®˜ç»†èŠ‚æå†™>
  },
  "state_update": {
    "hp_delta": <æ•´æ•°ï¼Œè´Ÿæ•°ä¸ºæ‰£è¡€ï¼Œæ­£æ•°ä¸ºå›è¡€ï¼ŒèŒƒå›´-30è‡³+20>,
    "spirit_delta": <æ•´æ•°ï¼ŒèŒƒå›´-25è‡³+15>,
    "stat_changes": <å­—ç¬¦ä¸²ï¼Œå¦‚"è§‰é†’åº¦ +2%"ï¼Œæ— å˜åŒ–åˆ™ä¸º"">,
    "inventory_note": <ç‰©å“å˜åŒ–è¯´æ˜ï¼Œæ— å˜åŒ–åˆ™ä¸º"">
  },
  "next_options": [
    <é€‰é¡¹1ï¼Œæ ¼å¼ï¼šã€ç±»å‹ã€‘è¡ŒåŠ¨æè¿°>,
    <é€‰é¡¹2>,
    <é€‰é¡¹3>,
    <é€‰é¡¹4>
  ]
}

**åˆ¤å®šè§„åˆ™ï¼š**
- roll 1-5: verdict = "æƒ¨è´¥"ï¼ˆé‡ä¼¤ï¼ŒHP -20è‡³-30ï¼Œå±€é¢å´©æºƒï¼‰
- roll 6-40: verdict = "æŒ«è´¥"ï¼ˆHP -10è‡³-20ï¼Œå±€é¢æ¶åŒ–ï¼‰
- roll 41-85: verdict = "æˆåŠŸ"ï¼ˆHP -3è‡³-8ï¼Œè¾¾æˆç›®çš„ï¼‰
- roll 86-100: verdict = "å¤§æˆåŠŸ"ï¼ˆHP -0è‡³-3ï¼Œé¢å¤–å¢ç›Šï¼‰

è‹¥ç©å®¶ç­‰çº§ä½äºç›®æ ‡30%ä»¥ä¸Šï¼Œrollå¼ºåˆ¶è¡°å‡è‡³0.05èŒƒå›´å†…ã€‚
è‹¥ç©å®¶è¡ŒåŠ¨æè¿°è¯¦ç»†ã€ç­–ç•¥åˆç†ï¼Œrollå¯é¢å¤–+10è‡³+20ã€‚
è‹¥è¡ŒåŠ¨é€»è¾‘ä¸¥é‡è¿èƒŒä¸–ç•Œè§‚ï¼Œç»™äºˆæƒ¨çƒˆåˆ¤å®šå¹¶åœ¨ reasoning ä¸­è¯´æ˜ã€‚

è¾“å‡ºå¿…é¡»æ˜¯åˆæ³• JSONï¼Œä¸å¾—åŒ…å«ä»»ä½• markdown ä»£ç å—æ ‡è®°ã€‚`;

      function generateToken() {
        return (
          "nf_" + Math.random().toString(36).substr(2, 16) + "_" + Date.now()
        );
      }

      function buildSystemPrompt() {
        let styleCtx = "";
        if (STATE.styleText) {
          styleCtx = `\n**å‚è€ƒæ–‡é£ï¼ˆè¯·ä¸¥æ ¼æ¨¡ä»¿ä»¥ä¸‹åŸè‘—é£æ ¼ï¼‰ï¼š**\n${STATE.styleText.slice(0, 800)}`;
        }
        return SYSTEM_PROMPT.replace("{HP}", STATE.hp)
          .replace("{MAX_HP}", STATE.maxHp)
          .replace("{SPIRIT}", STATE.spirit)
          .replace("{MAX_SPIRIT}", STATE.maxSpirit)
          .replace("{AWAKENING}", STATE.awakening)
          .replace("{LEVEL}", STATE.level)
          .replace("{TAGS}", STATE.tags.join("ã€"))
          .replace("{INVENTORY}", STATE.inventory.join("ã€"))
          .replace("{STYLE_CONTEXT}", styleCtx);
      }

      // File upload
      document
        .getElementById("mdUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            STATE.styleText = ev.target.result;
            document.getElementById("fileLoaded").style.display = "block";
            document.getElementById("fileLoaded").textContent =
              `âœ“ å·²åŠ è½½: ${file.name}`;
          };
          reader.readAsText(file);
        });

      function selectOption(btn) {
        const text = btn.querySelector("span")
          ? btn.textContent
              .replace(btn.querySelector(".option-type").textContent, "")
              .trim()
          : btn.textContent.trim();
        const actionInput = document.getElementById("actionInput");
        // Extract action text (remove the type prefix)
        const full = btn.innerText;
        const lines = full
          .trim()
          .split("\n")
          .filter((l) => l.trim());
        const actionText = lines.slice(1).join(" ").trim() || lines[0];
        actionInput.value = actionText;
        actionInput.focus();
      }

      function getVerdictClass(verdict) {
        const map = {
          æƒ¨è´¥: "verdict-disaster",
          æŒ«è´¥: "verdict-fail",
          æˆåŠŸ: "verdict-success",
          å¤§æˆåŠŸ: "verdict-great",
        };
        return map[verdict] || "verdict-success";
      }

      function getLogVerdictClass(verdict) {
        const map = {
          æƒ¨è´¥: "log-verdict-d",
          æŒ«è´¥: "log-verdict-f",
          æˆåŠŸ: "log-verdict-s",
          å¤§æˆåŠŸ: "log-verdict-g",
        };
        return map[verdict] || "log-verdict-s";
      }

      function updateStats(delta) {
        const deltaLog = document.getElementById("deltaLog");

        if (delta.hp_delta !== 0) {
          STATE.hp = Math.max(
            0,
            Math.min(STATE.maxHp, STATE.hp + delta.hp_delta),
          );
          document.getElementById("hpVal").textContent = STATE.hp;
          document.getElementById("hpBar").style.width =
            (STATE.hp / STATE.maxHp) * 100 + "%";
          const cls = delta.hp_delta < 0 ? "delta-neg" : "delta-pos";
          const sign = delta.hp_delta > 0 ? "+" : "";
          deltaLog.innerHTML =
            `<span class="delta ${cls}">HP ${sign}${delta.hp_delta}</span>` +
            deltaLog.innerHTML;
        }

        if (delta.spirit_delta !== 0) {
          STATE.spirit = Math.max(
            0,
            Math.min(STATE.maxSpirit, STATE.spirit + delta.spirit_delta),
          );
          document.getElementById("spiritVal").textContent = STATE.spirit;
          document.getElementById("spiritBar").style.width =
            (STATE.spirit / STATE.maxSpirit) * 100 + "%";
          const cls = delta.spirit_delta < 0 ? "delta-neg" : "delta-pos";
          const sign = delta.spirit_delta > 0 ? "+" : "";
          deltaLog.innerHTML =
            `<span class="delta ${cls}">ç²¾ç¥ ${sign}${delta.spirit_delta}</span>` +
            deltaLog.innerHTML;
        }

        if (delta.stat_changes && delta.stat_changes.includes("è§‰é†’åº¦")) {
          const match = delta.stat_changes.match(/è§‰é†’åº¦\s*([+-]?\d+)/);
          if (match) {
            STATE.awakening = Math.max(
              0,
              Math.min(100, STATE.awakening + parseInt(match[1])),
            );
            document.getElementById("awakenVal").textContent = STATE.awakening;
            document.getElementById("awakenBar").style.width =
              STATE.awakening + "%";
            deltaLog.innerHTML =
              `<span class="delta delta-pos">è§‰é†’ ${match[1]}%</span>` +
              deltaLog.innerHTML;
          }
        }
      }

      function updateOptions(options) {
        const row = document.getElementById("optionsRow");
        row.innerHTML = "";
        options.forEach((opt) => {
          // Parse type and text
          const typeMatch = opt.match(/^ã€(.+?)ã€‘(.+)$/);
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.onclick = function () {
            selectOption(this);
          };
          if (typeMatch) {
            btn.innerHTML = `<span class="option-type">ã€${typeMatch[1]}ã€‘</span>${typeMatch[2].trim()}`;
          } else {
            btn.textContent = opt;
          }
          row.appendChild(btn);
        });
      }

      function addToLog(action, roll, verdict) {
        const log = document.getElementById("battleLog");
        const now = new Date();
        const time = `T${STATE.turnCount} Â· ${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `
          <div class="log-time">${time}</div>
          <div class="log-action">${action.slice(0, 40)}${action.length > 40 ? "â€¦" : ""}</div>
          <div class="log-result">
            <span class="log-roll">âš„ ${roll}</span>
            <span class="${getLogVerdictClass(verdict)}">${verdict}</span>
          </div>
        `;
        log.insertBefore(entry, log.firstChild);
      }

      function renderNarrative(data, action) {
        const content = document.getElementById("storyContent");
        const scroll = document.getElementById("narrativeScroll");

        // Hide welcome
        document.getElementById("welcomeScreen").style.display = "none";

        // Chapter marker
        if (STATE.turnCount % 5 === 0) {
          const marker = document.createElement("div");
          marker.className = "chapter-marker";
          marker.innerHTML = `<span>ç¬¬ ${Math.floor(STATE.turnCount / 5) + 1} ç«  Â· å›åˆ ${STATE.turnCount}</span>`;
          content.appendChild(marker);
        }

        // Judge card
        const judgeCard = document.createElement("div");
        judgeCard.className = "judge-card";
        judgeCard.innerHTML = `
          <div class="dice-display">${data.judge_report.roll}</div>
          <div class="judge-meta">
            <span class="verdict-badge ${getVerdictClass(data.judge_report.verdict)}">${data.judge_report.verdict}</span>
            <div class="judge-reasoning">${data.judge_report.reasoning}</div>
          </div>
        `;
        content.appendChild(judgeCard);

        // Prose
        const proseBlock = document.createElement("div");
        proseBlock.className = "prose-block";
        const paragraphs = data.narrative.prose
          .split(/\n+/)
          .filter((p) => p.trim());
        let proseHtml = '<div class="prose-text">';
        paragraphs.forEach((p) => {
          proseHtml += `<p>${p.trim()}</p>`;
        });
        proseHtml += "</div>";
        if (data.narrative.sensory_detail) {
          proseHtml += `<div class="sensory-note">${data.narrative.sensory_detail}</div>`;
        }
        proseBlock.innerHTML = proseHtml;
        content.appendChild(proseBlock);

        // State changes display
        if (data.state_update) {
          updateStats(data.state_update);
        }

        // Session token (hidden)
        const tokenEl = document.createElement("div");
        tokenEl.style.display = "none";
        tokenEl.dataset.token = STATE.sessionToken;
        tokenEl.dataset.turn = STATE.turnCount;
        content.appendChild(tokenEl);

        // Scroll to bottom
        setTimeout(() => {
          scroll.scrollTop = scroll.scrollHeight;
        }, 100);
      }

      async function submitAction() {
        const input = document.getElementById("actionInput");
        const action = input.value.trim();
        if (!action) return;

        const btn = document.getElementById("submitBtn");
        const loader = document.getElementById("loadingIndicator");
        const errorEl = document.getElementById("errorMsg");

        btn.disabled = true;
        loader.classList.add("active");
        errorEl.style.display = "none";
        input.value = "";
        STATE.turnCount++;

        try {
          const response = await fetch(
            "https://2c2ch1u11-share-api-0.hf.space/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer sk-b309603f-48c8-4c14-8373-f13168f612cc",
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                max_tokens: 1000,
                messages: [
                  { role: "system", content: buildSystemPrompt() },
                  { role: "user", content: `ç©å®¶è¡ŒåŠ¨ï¼š${action}` },
                ],
              }),
            },
          );

          const responseData = await response.json();
          const rawText = responseData.choices[0].message.content;

          // Parse JSON - strip any markdown fences
          let cleaned = rawText
            .replace(/```json\n?/g, "")
            .replace(/```\n?/g, "")
            .trim();
          const parsed = JSON.parse(cleaned);

          renderNarrative(parsed, action);
          addToLog(
            action,
            parsed.judge_report.roll,
            parsed.judge_report.verdict,
          );

          if (parsed.next_options && parsed.next_options.length) {
            updateOptions(parsed.next_options);
          }
        } catch (err) {
          errorEl.style.display = "block";
          errorEl.textContent = `åˆ¤å®šå¤±è´¥ï¼š${err.message}ã€‚è¯·æ£€æŸ¥ API è¿æ¥çŠ¶æ€ã€‚`;
          STATE.turnCount--;
        } finally {
          btn.disabled = false;
          loader.classList.remove("active");
        }
      }

      // Enter to submit
      document
        .getElementById("actionInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            submitAction();
          }
        });
    </script>
  </body>
</html>
